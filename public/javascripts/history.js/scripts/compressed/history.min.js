/*
 Public Domain
 @author Benjamin Lupton <contact@balupton.com>
 @author James Padolsey <https://gist.github.com/527683>
 Public Domain
 @author Benjamin Lupton <contact@balupton.com>
*/
(function(i,l){i.History=i.History||{};var f=i.document,c={},b=i.History,k=i.history;if(typeof b.emulated!=="undefined")throw Error("History.js has already been emulated...");b.init=function(){b.options={hashChangeCheckerDelay:100};b.debug=function(){b.debug.enable&&b.log.apply(b,arguments)};b.debug.enable=true;b.log=function(){var a=typeof console!=="undefined";a&&console.log.apply(console,[arguments]);for(var d="\n"+arguments[0]+"\n",e=1,g=arguments.length;e<g;++e)d+="\n"+arguments[e]+"\n";if(e=
f.getElementById("log"))e.value+=d+"\n-----\n";else a||alert(d);return true};c.getInternetExplorerMajorVersion=function(){return c.getInternetExplorerMajorVersion.cached=typeof c.getInternetExplorerMajorVersion.cached!=="undefined"?c.getInternetExplorerMajorVersion.cached:function(){for(var a=3,d=f.createElement("div"),e=d.getElementsByTagName("i");d.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>",e[0];);return a>4?a:void 0}()};c.isInternetExplorer=function(){return c.isInternetExplorer.cached=
typeof c.isInternetExplorer.cached!=="undefined"?c.isInternetExplorer.cached:c.getInternetExplorerMajorVersion()!==0};b.emulated={pushState:!Boolean(i.history&&i.history.pushState&&i.history.replaceState),hashChange:Boolean(!("onhashchange"in i||"onhashchange"in f)||c.isInternetExplorer()&&c.getInternetExplorerMajorVersion()<8)};b.setHash=function(a){var d=b.normalizeHash(a);b.debug("History.setHash",this,arguments,"hash:",a,"normalizedHash:",d);f.location.hash=d;return a};b.getHash=function(){return b.normalizeHash(f.location.hash)};
b.normalizeHash=function(a){return a.replace(/[^#]*#/,"").replace(/#.*/,"")};b.extractHashFromUrl=function(a){return String(a).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2")};b.isTraditionalAnchor=function(a){a=b.extractHashFromUrl(a);return typeof f.getElementById(a)!=="undefined"};b.expandUrl=function(a){if(!/[a-z]+\:\/\//.test(a))if(a.length===0||a.substring(0,1)==="?")a=f.location.href.replace(/[#\?].*/,"")+a;else{var d=f.getElementsByTagName("base"),e=null;e="";if(d.length===1){e=d[0];e=e.href;if(e[e.length-
1]!=="/")e+="/";a=e+a.replace(/^\//,"")}else if(a.substring(0,1)==="."){d=f.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,"");if(d[d.length-1]!=="/")d+="/";a=d+a}else{d=f.location.protocol+"//"+(f.location.hostname||f.location.host);if(f.location.port)d+=":"+f.location.port;d+="/";a=d+a.replace(/^\//,"")}}return a};b.expandState=function(a){a=a||{};a={data:a.data||{},url:b.expandUrl(a.url||""),title:a.title||""};a.data.title=a.data.title||a.title;a.data.url=a.data.url||a.url;return a};b.createStateObject=
function(a,d,e){a={data:a,title:d,url:e};return a=b.expandState(a)};b.createStateHash=function(a){return JSON.stringify(a)};c.statesByUrl={};c.duplicateStateUrls={};c.statesByHash={};c.savedStates=[];b.getState=function(){return c.getStateByIndex()};b.getStateHash=function(){return b.createStateHash(b.getState())};c.getStateByUrl=function(a){return c.statesByUrl[a]||l};c.getStateByHash=function(a){return c.statesByHash[a]||l};c.storeState=function(a){var d=b.createStateHash(a),e=c.getStateByUrl(a.url);
if(typeof e!=="undefined")if(b.createStateHash(e)!==d)c.duplicateStateUrls[a.url]=true;c.statesByUrl[a.url]=c.statesByHash[d]=a;return true};c.isLastState=function(a){a=b.createStateHash(a);var d=b.getStateHash();return a===d};c.saveState=function(a){if(c.isLastState(a))return false;c.savedStates.push(a);return true};c.getStateByIndex=function(a){var d=null;return d=typeof a==="undefined"?c.savedStates[c.savedStates.length-1]:a<0?c.savedStates[c.savedStates.length+a]:c.savedStates[a]};c.stateUrlExists=
function(a){return typeof c.statesByUrl[a]!=="undefined"};c.urlDuplicateExists=function(a){return typeof c.duplicateStateUrls[a]!=="undefined"};c.savedHashes=[];c.isLastHash=function(a){var d=c.getHashByIndex();return a===d};c.saveHash=function(a){if(c.isLastHash(a))return false;c.savedHashes.push(a);return true};c.getHashByIndex=function(a){var d=null;return d=typeof a==="undefined"?c.savedHashes[c.savedHashes.length-1]:a<0?c.savedHashes[c.savedHashes.length+a]:c.savedHashes[a]};c.stateHashExists=
function(a){return typeof c.statesByHash[a]!=="undefined"};c.discardedHashes={};c.discardedStates={};c.discardState=function(a,d,e){b.debug("History.discardState",this,arguments);var g=b.createStateHash(a);c.discardedStates[g]={discardedState:a,backState:e,forwardState:d};return true};c.discardHash=function(a,d,e){b.debug("History.discardState",this,arguments);c.discardedHashes[a]={discardedHash:a,backState:e,forwardState:d};return true};c.discardedState=function(a){a=b.createStateHash(a);return c.discardedStates[a]||
false};c.discardedHash=function(a){return c.discardedHashes[a]||false};c.recycleState=function(a){b.debug("History.recycleState",this,arguments);var d=b.createStateHash(a);c.discardedState(a)&&delete c.discardedStates[d];return true};b.emulated.hashChange&&function(){c.checkerFunction=null;if(c.isInternetExplorer()){var a=f.createElement("iframe");a.setAttribute("id","historyjs-iframe");a.style.display="none";f.body.appendChild(a);a.contentWindow.document.open();a.contentWindow.document.close();var d=
null,e=null,g=false;c.checkerFunction=function(){if(g){b.debug("hashchange.checker: checker is running");return false}g=true;var h=b.getHash(),j=b.normalizeHash(a.contentWindow.document.location.hash);if(h!==d){d=h;if(j!==h){b.debug("hashchange.checker: iframe hash change",j,h);e=h;a.contentWindow.document.open();a.contentWindow.document.close();a.contentWindow.document.location.hash=h}b.Adapter.trigger(i,"hashchange")}else if(j!==e){b.debug("hashchange.checker: iframe hash out of sync",j,h);e=j;
b.setHash(j)}g=false;return true}}else{d=null;c.checkerFunction=function(){var h=b.getHash();if(h!==d){d=h;b.Adapter.trigger(i,"hashchange")}return true}}setInterval(c.checkerFunction,b.options.hashChangeCheckerDelay);return true}();if(b.emulated.pushState){c.onHashChange=function(a){b.debug("_History.onHashChange",this,arguments);currentHash=unescape(b.extractHashFromUrl(a&&a.newURL||f.location.href));currentStateHashExits=currentStateHash=currentState=null;if(c.isLastHash(currentHash)){b.log("_History.onHashChange: no change");
return false}c.saveHash(currentHash);try{currentState=JSON.parse(currentHash)}catch(d){b.log("_History.onHashChange: traditional anchor");b.Adapter.trigger("anchorchange");return false}if(c.isLastState(currentState)){b.log("_History.onHashChange: no change");return false}currentStateHash=b.createStateHash(currentState);b.log("_History.onHashChange: ","currentStateHash",currentStateHash,"Hash -1",c.getHashByIndex(-1),"Hash -2",c.getHashByIndex(-2),"Hash -3",c.getHashByIndex(-3),"Hash -4",c.getHashByIndex(-4),
"Hash -5",c.getHashByIndex(-5),"Hash -6",c.getHashByIndex(-6),"Hash -7",c.getHashByIndex(-7));var e=c.discardedState(currentState);if(e){b.log("forwardState:",b.createStateHash(e.forwardState),"backState:",b.createStateHash(e.backState));if(c.getHashByIndex(-2)===b.createStateHash(e.forwardState)){b.log("_History.onHashChange: go backwards");b.back()}else{b.log("_History.onHashChange: go forwards");b.forward()}return false}b.debug("_History.onHashChange: success hashchange");b.pushState(currentState.data,
currentState.title,currentState.url);return true};b.Adapter.bind(i,"hashchange",c.onHashChange);b.pushState=function(a,d,e){b.debug("History.pushState",this,arguments);if(b.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");var g=b.createStateObject(a,d,e),h=b.createStateHash(g);b.getState();var j=b.getStateHash(),m=unescape(b.getHash());c.storeState(g);c.recycleState(g);if(g.title)f.title=g.title;b.log("History.pushState: details",
"newStateHash:",h,"oldStateHash:",j,"html4Hash:",m);if(h===j){b.log("History.pushState: no change");return false}if(h!==m){b.log("History.pushState: update hash");b.setHash(escape(h));return false}c.saveState(g);b.log("History.pushState: trigger popstate");b.Adapter.trigger(i,"statechange");return true};b.replaceState=function(a,d,e){b.log("History.replaceState",this,arguments);if(b.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");
var g=b.createStateObject(a,d,e),h=b.getState(),j=c.getStateByIndex(-2);c.discardState(h,g,j);b.pushState(g.data,g.title,g.url);return true};if(!f.location.hash||f.location.hash==="#")b.Adapter.onDomLoad(function(){b.log("hash1");var a=b.createStateObject({},"",f.location.href);b.pushState(a.data,a.title,a.url)});else if(!b.emulated.hashChange){b.log("hash2");b.Adapter.onDomLoad(function(){c.onHashChange()})}}else{c.onPopState=function(a){b.debug("_History.onPopState",this,arguments);var d=unescape(b.getHash());
if(d){try{var e=JSON.parse(d);b.log("_History.onPopState: state anchor",d,e);b.replaceState(e.data,e.tite,e.url)}catch(g){b.log("_History.onPopState: traditional anchor",d);b.Adapter.trigger(i,"anchorchange")}return false}d={};var h=e=null;d=null;a=a||{};if(typeof a.state==="undefined")if(typeof a.originalEvent!=="undefined"&&typeof a.originalEvent.state!=="undefined")a.state=a.originalEvent.state;else if(typeof a.event!=="undefined"&&typeof a.event.state!=="undefined")a.state=a.event.state;if(a.state===
null)d=a.state;else if(typeof a.state!=="undefined"){e=b.expandUrl(f.location.href);d=c.getStateByUrl(e);e=c.urlDuplicateExists(e);d=typeof d!=="undefined"&&!e?d.data:a.state}else{e=b.expandUrl(f.location.href);d=c.getStateByUrl(e);if(e==d.url)d=d.data;else throw Error("Unknown state");}d=typeof d!=="object"||d===null?{}:d;e=d.title||"";h=d.url||f.location.href;d=b.createStateObject(d,e,h);if(c.isLastState(d)){b.log("_History.onPopState: no change");return false}b.debug("_History.onPopState","newState:",
d,"oldState:",c.getStateByUrl(b.expandUrl(f.location.href)),"duplicateExists:",c.urlDuplicateExists(b.expandUrl(f.location.href)));c.storeState(d);c.saveState(d);if(d.title)f.title=d.title;b.Adapter.trigger(i,"statechange");return true};b.Adapter.bind(i,"popstate",c.onPopState);b.pushState=function(a,d,e){if(b.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");a=b.createStateObject(a,d,e);c.storeState(a);k.pushState(a.data,a.title,
a.url);b.Adapter.trigger(i,"popstate");return true};b.replaceState=function(a,d,e){if(b.extractHashFromUrl(e))throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");a=b.createStateObject(a,d,e);c.storeState(a);k.replaceState(a.data,a.title,a.url);b.Adapter.trigger(i,"popstate");return true}}b.back=function(){b.debug("History.back: called");if(b.emulated.hashChange&&c.isInternetExplorer()){var a=b.getHash();setTimeout(function(){if(b.getHash()===a){b.debug("History.back: trying again");
return b.back()}return true},b.options.hashChangeCheckerDelay*2)}return k.go(-1)};b.forward=function(){b.debug("History.forward: called");if(b.emulated.hashChange&&c.isInternetExplorer()){var a=b.getHash();setTimeout(function(){if(b.getHash()===a){b.debug("History.forward: trying again");return b.forward()}return true},b.options.hashChangeCheckerDelay*2)}return k.go(1)}};typeof b.Adapter!=="undefined"&&b.init()})(window);
